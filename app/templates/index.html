{% extends "base.html" %}
{% block main_class %}section--fluid{% endblock %}

{% block title %}Consulta {{ txid }} – {{ telefono }}{% endblock %}

{# Helper: obtener valor por key desde "cards" #}
{% macro val(k) -%}
  {%- for c in cards -%}{%- if c.key == k -%}{{ (c.value or '')|trim }}{%- endif -%}{%- endfor -%}
{%- endmacro %}

{# Tomo genero y fecha de nacimiento para el header #}
{% set ns = namespace(genero='', birth='') %}
{% for c in cards %}
  {% if c.key == 'genero' %}{% set ns.genero = (c.value or '')|trim %}{% endif %}
  {% if c.key in ['fecha_nacimiento','birth_date'] %}{% set ns.birth = (c.value or '')|trim %}{% endif %}
{% endfor %}

{# ===== Header específico de esta pantalla ===== #}
{% block header %}
  <header class="app-header" style="display:grid; grid-template-columns:1fr auto 1fr; align-items:center;">
    <!-- IZQUIERDA: logo + “nombre” (teléfono) · edad · género -->
    <div style="display:flex; align-items:center; gap:8px; min-width:0;">
      <img
        src="https://mi-bucket-milito.s3.us-east-1.amazonaws.com/Captura+de+pantalla+2025-07-19+a+la(s)+10.57.00%E2%80%AFp.%C2%A0m..png"
        alt="Logo Sanatorio Mater Dei" class="app-logo">
      <div class="session-title" style="display:flex; gap:8px; flex-wrap:wrap;">
        <span><strong>{{ telefono }}</strong></span>
        <span>· <span id="age-text" data-birth="{{ ns.birth|e }}">—</span> años</span>
        <span>· {{ ns.genero or "—" }}</span>
      </div>
    </div>

    <!-- CENTRO: triage (refleja el input) -->
    <div style="justify-self:center;">
      <span id="triage-chip" class="btn" style="pointer-events:none;">
        {{ val('triage') }}
      </span>
    </div>

    <!-- DERECHA: acciones -->
    <div class="actions actions--header" style="justify-self:end;">
      <button form="consulta-form" type="submit" class="btn primary">Revisar y confirmar</button>
      <a class="btn" href="{{ url_for('routes.index', tel=telefono) }}">Cancelar</a>
    </div>
  </header>
{% endblock %}

{% block content %}
  <div class="px-dashboard" style="height: calc(100vh - var(--header-h)); grid-template-rows: 1fr;">

    <form id="consulta-form" method="post" action="{{ url_for('routes.revisar') }}">

      {{ csrf_token() if csrf_token is defined }}
      <!-- Hidden requeridos -->
      <input type="hidden" name="tel" value="{{ telefono }}">
      <input type="hidden" name="txid" value="{{ txid }}">
      <input type="hidden" name="tx_id" value="{{ txid }}">
      <input type="hidden" name="encounter_started_at" value="{{ encounter_started_at }}">
      <input type="hidden" name="clinician_name" value="{{ clinician_name or 'Virginia Fux' }}">
      <input type="hidden" name="clinician_license" value="{{ clinician_license or 'MP123' }}">
      <input type="hidden" name="fecha_nacimiento" value="{{ ns.birth }}">
      <input type="hidden" name="genero" id="genero-hidden" value="{{ ns.genero }}">

      <div class="grid3">
        <!-- ======================= Columna 1 ======================= -->
        <section class="col" style="min-height:0;">
          <div style="height:100%; overflow:auto; padding-right:6px;">
            <article class="card" aria-labelledby="c1-h" style="height:100%; display:flex; flex-direction:column; min-height:0;">
              <header id="c1-h">Consulta actual</header>

            <div class="field-block">
              <label class="field-label"><strong>Motivo de consulta</strong></label>
              <input class="input" type="text" name="motivo_consulta" value="{{ val('motivo_consulta') }}">
            </div>

            <div class="field-block">
              <label class="field-label"><strong>Síntoma principal</strong></label>
              <input class="input" type="text" name="sintoma_principal" value="{{ val('sintoma_principal') }}">
            </div>
            <div class="field-block">
              <label class="field-label"><strong>Síntomas asociados</strong></label>
              <textarea class="input textarea-fixed" name="sintomas_asociados">{{ val('sintomas_asociados') }}</textarea>
            </div>

            <div class="field-block">
              <label class="field-label"><strong>Factor desencadenante</strong></label>
              <input class="input" type="text" name="factor_desencadenante" value="{{ val('factor_desencadenante') }}">
            </div>

            <div class="field-block">
              <label class="field-label"><strong>Dolor</strong></label>
              <input class="input" type="text" name="dolor" value="{{ val('dolor') }}" placeholder="0–10 o texto">
            </div>

            <div class="field-block">
              <label class="field-label"><strong>Inicio</strong></label>
              <input class="input" type="text" name="inicio" value="{{ val('inicio') }}">
            </div>

            <div class="field-block">
              <label class="field-label"><strong>Evolución</strong></label>
              <textarea class="input textarea-fixed" name="evolucion">{{ val('evolucion') }}</textarea>
            </div>

            <div class="field-block">
              <label class="field-label"><strong>Embarazo</strong></label>
              {% set embar = val('embarazo') %}
              <select class="input" name="embarazo" required>
                <option value="" disabled {{ (embar=='' or embar=='Seleccionar') and 'selected' or '' }}>Seleccionar…</option>
                <option value="Si"         {{ embar in ['Si','Sí'] and 'selected' or '' }}>Sí</option>
                <option value="No"         {{ embar=='No' and 'selected' or '' }}>No</option>
                <option value="Desconoce"  {{ embar=='Desconoce' and 'selected' or '' }}>Desconoce</option>
              </select>
            </div>

            <div class="field-block">
              <label class="field-label"><strong>Medicación recibida</strong></label>
              <textarea class="input textarea-fixed" name="medicacion_recibida">{{ val('medicacion_recibida') }}</textarea>
            </div>
          </article>
        </section>



        <!-- ======================= Columna 2 (SCROLLEABLE ENTERA) ======================= -->
        <section class="col" style="min-height:0;">


          <div style="height:100%; overflow:auto; padding-right:6px;">

            <article class="card" aria-labelledby="c2a-h" style="margin-bottom: var(--gap);">
              <header id="c2a-h">Antecedentes del paciente</header>

              <div class="field-block">
                <label class="field-label"><strong>Antecedentes personales</strong></label>
                <textarea class="input textarea-fixed" name="antecedentes_personales">{{ val('antecedentes_personales') }}</textarea>
              </div>

              <div class="field-block">
                <label class="field-label"><strong>Antecedentes familiares relevantes</strong></label>
                <textarea class="input textarea-fixed" name="antecedentes_familiares">{{ val('antecedentes_familiares') }}</textarea>
              </div>

              <div class="field-block">
                <label class="field-label"><strong>Cirugías previas</strong></label>
                <textarea class="input textarea-fixed" name="cirugias_previas">{{ val('cirugias_previas') }}</textarea>
              </div>
            </article>
          

            <article class="card" aria-labelledby="c2b-h">
              <header id="c2b-h">Medicación</header>

              <div class="field-block">
                <label class="field-label"><strong>Medicación habitual</strong></label>
                <textarea class="input textarea-fixed" name="medicacion_habitual">{{ val('medicacion_habitual') }}</textarea>
              </div>

              <div class="field-block">
                <label class="field-label"><strong>Alergias</strong></label>
                <textarea class="input textarea-fixed" name="alergias">{{ val('alergias') }}</textarea>
              </div>

              <div class="field-block">
                <label class="field-label"><strong>Vacunas</strong></label>
                <textarea class="input textarea-fixed" name="vacunas">{{ val('vacunas') }}</textarea>
              </div>
            </article>
          </div>
        </section>

        <!-- ======================= Columna 3 ======================= -->
        <section class="col" style="min-height:0;">
          <article class="card card-examen" aria-labelledby="c3-h"
                  style="height:100%; display:flex; flex-direction:column; min-height:0;">
            <header id="c3-h">Examen físico / Anamnesis</header>
            <div class="field-block" style="flex:1 1 auto; min-height:0;">
              <label class="sr-only">Examen físico / Anamnesis</label>
              <textarea class="input textarea-fixed" name="examen_fisico"
                        style="height:100%; min-height:0; max-height:none;">{{ val('examen_fisico') }}</textarea>
            </div>
          </article>
        </section>



      </div>
    </form>
  </div>
{% endblock %}

{% block scripts %}
<script>
  // Edad a partir de fecha_nacimiento (YYYY-MM-DD o ISO)
  (function(){
    const el = document.getElementById('age-text');
    const raw = el?.dataset.birth || '';
    if (!raw) return;
    const d = new Date(raw);
    if (isNaN(d)) return;
    const t = new Date();
    let age = t.getFullYear() - d.getFullYear();
    const m = t.getMonth() - d.getMonth();
    if (m < 0 || (m === 0 && t.getDate() < d.getDate())) age--;
    el.textContent = age;
  })();

  // Reflejar triage del input al chip del header
  (function(){
    const input = document.getElementById('triage-input');
    const chip  = document.getElementById('triage-chip');
    if (!input || !chip) return;
    const sync = () => { chip.textContent = input.value || '—'; };
    sync();
    input.addEventListener('input', sync);
  })();
</script>
{% endblock %}

