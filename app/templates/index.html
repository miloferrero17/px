{% extends "base.html" %}
{% block main_class %}section--fluid{% endblock %}

{% block title %}Consulta {{ txid }} – {{ telefono }}{% endblock %}

{# Helper: obtener valor por key desde "cards" #}
{% macro val(k) -%}
  {%- for c in cards -%}{%- if c.key == k -%}{{ (c.value or '')|trim }}{%- endif -%}{%- endfor -%}
{%- endmacro %}

{# Tomo genero y fecha de nacimiento para el header #}
{% set ns = namespace(genero='', birth='') %}
{% for c in cards %}
  {% if c.key == 'genero' %}{% set ns.genero = (c.value or '')|trim %}{% endif %}
  {% if c.key in ['fecha_nacimiento','birth_date'] %}{% set ns.birth = (c.value or '')|trim %}{% endif %}
{% endfor %}

{% block header %}
  <style>
    /* ===== Page-scoped tweaks (no tocan el CSS global) ===== */

    .consulta-header .h-left{ display:flex; align-items:center; gap:12px; min-width:0; }
    .consulta-header .session-title{ display:flex; align-items:center; flex-wrap:wrap; gap:8px; }
    .consulta-header .actions--header{ display:flex; align-items:center; gap:10px; }

    .patient-phone{
      font-family: var(--font); font-weight:600; /* semibold */
      font-variant-numeric: tabular-nums; font-feature-settings: "tnum" 1;
    }
    .app-header.consulta-header{
      /* SIN display aquí: lo define .header-grid */
      align-items:center;
      gap: var(--gap);
      min-height: var(--header-h);
      padding: 0 16px;
    }
    /* Header en 3 columnas: izquierda · centro (triage) · derecha */
    .header-grid{
      display:grid !important;
      grid-template-columns: 1fr auto 1fr;
      align-items:center;
      column-gap: var(--gap);
    }
    .header-grid .h-left{ justify-self:start; }
    .header-grid .h-center{ display:flex; align-items:center; justify-content:center; justify-self:center; }
    .header-grid .actions--header{ justify-self:end; }

    .h-left,
    .actions--header{
      display:flex;
      align-items:center;
      /* sin height fijo */
    }
    .actions--header .btn{ margin:0; }

    .session-title span{ line-height:1.1; }


    /* Tipografía un poco más grande en campos (base=12px) */
    .app-page-consulta{ --fs-label: calc(var(--fs-base) + 3px); --fs-input: calc(var(--fs-base) + 5px); }
    .app-page-consulta .field-label{ font-size: var(--fs-label); line-height:1.25; }
    .app-page-consulta .input{ font-size: var(--fs-input); line-height:1.35; }
    .app-page-consulta .input::placeholder{ font-size: var(--fs-input); opacity:.6; }

    /* Grid de 3 columnas que ocupa la altura visible */
    .app-page-consulta .grid3{
      display:grid; gap: var(--gap);
      grid-template-columns: 1 fr 1 fr 1 fr;   /* se puede ajustar si hace falta */
      height: calc(100vh - var(--header-h) - 10px);
      padding-right: 6px; /* respeta tu separación actual */
    }
    .app-page-consulta .col{ display:flex; flex-direction:column; min-height:0; }
    .app-page-consulta .col-inner{ display:flex; flex-direction:column; min-height:0; height:100%; overflow:hidden; gap: var(--gap); }

    .app-page-consulta .card{ display:flex; flex-direction:column; min-height:0; }
    .app-page-consulta .card--fill{ flex:1 1 auto; min-height:0; }
    .app-page-consulta .card--scroll{ overflow:hidden; }
    .app-page-consulta .card--scroll > *{ min-height:0; }
    .app-page-consulta .card--scroll .input,
    .app-page-consulta .card--scroll .scroll,
    .app-page-consulta .card--scroll .content{ overflow:auto; }
    .app-page-consulta .card{ overflow:hidden; }  /* también respeta el border-radius */
    .app-page-consulta .card > .field-block:last-child{ margin-bottom: 0 !important; }

    .app-page-consulta article > header,
    .app-page-consulta .card > header{
      font-size: calc(var(--fs-base) + 6px); /* con base=12px → 18px */
      line-height: 1.2;
    }

    /* Textareas controladas: no crecen infinito */
    .app-page-consulta textarea.textarea-fixed{ resize: vertical; max-height:60vh; }

    @media (max-width: 1200px){
      .app-page-consulta .grid3{ grid-template-columns:1fr; height:auto; }
      .app-page-consulta .card--fill{ flex:unset; }
    }
    /* Unificar tipografía + altura de todos los inputs/selects/textareas */
    .app-page-consulta input.input,
    .app-page-consulta select.input,
    .app-page-consulta textarea.input{
      font-size: var(--fs-input) !important; /* fuerza tamaño parejo */
      font-family: var(--font);
      line-height: 1.35;
    }

    .app-page-consulta input.input,
    .app-page-consulta select.input{
      height: 38px;            /* altura uniforme (ajustable a 36/40) */
      padding: 0 12px;
    }

    .app-page-consulta textarea.input{
      padding: 8px 12px;
    }

    /* Placeholders al mismo tamaño */
    .app-page-consulta .input::placeholder{ font-size: var(--fs-input); opacity:.6; }
    .app-header .actions{ margin-top: 0 !important; }

  </style>

  <header class="app-header consulta-header header-grid">

    <!-- IZQUIERDA: logo + teléfono + edad + género + triage -->
    <div class="h-left">
      <img
        src="https://mi-bucket-milito.s3.us-east-1.amazonaws.com/Captura+de+pantalla+2025-07-19+a+la(s)+10.57.00%E2%80%AFp.%C2%A0m..png"
        alt="Logo Sanatorio Mater Dei" class="app-logo">
      <div class="session-title">
        <span class="patient-phone">{{ telefono }}</span>
        <span>· <span id="age-text" data-birth="{{ ns.birth|e }}">—</span> años</span>
        <span>· {{ ns.genero or "—" }}</span>

      </div>

    </div>
    <div class="h-center">
      <span id="triage-chip" class="btn triage-chip">{{ val('triage') }}</span>
    </div>

    <!-- DERECHA: acciones -->
    <div class="actions actions--header">
      <button form="consulta-form" type="submit" class="btn primary">Continuar</button>
      <a class="btn" href="{{ url_for('routes.index', tel=telefono) }}">Volver</a>
    </div>
  </header>
{% endblock %}

{% block content %}
  <div class="px-dashboard app-page-consulta">

    <form id="consulta-form" method="post" action="{{ url_for('routes.revisar') }}">

      {{ csrf_token() if csrf_token is defined }}
      <!-- Hidden requeridos -->
      <input type="hidden" name="tel" value="{{ telefono }}">
      <input type="hidden" name="txid" value="{{ txid }}">
      <input type="hidden" name="tx_id" value="{{ txid }}">
      <input type="hidden" name="encounter_started_at" value="{{ encounter_started_at }}">
      <input type="hidden" name="clinician_name" value="{{ clinician_name or 'Virginia Fux' }}">
      <input type="hidden" name="clinician_license" value="{{ clinician_license or 'MP123' }}">
      <input type="hidden" name="fecha_nacimiento" value="{{ ns.birth }}">
      <input type="hidden" name="genero" id="genero-hidden" value="{{ ns.genero }}">

      <div class="grid3">
        <!-- ======================= Columna 1 ======================= -->
        <section class="col">
          <div class="col-inner">
            <article class="card card--fill card--scroll card--muted" aria-labelledby="c1-h">

              <header id="c1-h">Consulta actual</header>
              <div class="scroll" style="flex:1 1 auto; min-height:0;">


              <div class="field-block">
                <label class="field-label"><strong>Motivo de consulta</strong></label>
                <textarea class="input textarea-fixed" name="motivo_consulta">{{ val('motivo_consulta') }}</textarea>

              </div>

              <div class="field-block">
                <label class="field-label"><strong>Síntoma principal</strong></label>
                <textarea class="input textarea-fixed" name="sintoma_principal">{{ val('sintoma_principal') }}</textarea>

              </div>

              <div class="field-block">
                <label class="field-label"><strong>Síntomas asociados</strong></label>
                <textarea class="input textarea-fixed" name="sintomas_asociados">{{ val('sintomas_asociados') }}</textarea>
              </div>

              <div class="field-block">
                <label class="field-label"><strong>Factor desencadenante</strong></label>
                <textarea class="input textarea-fixed" name="factor_desencadenante">{{ val('factor_desencadenante') }}</textarea>

              </div>

              <div class="field-block">
                <label class="field-label"><strong>Dolor</strong></label>
                <input class="input" type="text" name="dolor" value="{{ val('dolor') }}" placeholder="0–10 o texto">
              </div>

              <div class="field-block">
                <label class="field-label"><strong>Inicio</strong></label>
                <textarea class="input textarea-fixed" name="inicio">{{ val('inicio') }}</textarea>
              </div>

              <div class="field-block">
                <label class="field-label"><strong>Evolución</strong></label>
                <textarea class="input textarea-fixed" name="evolucion">{{ val('evolucion') }}</textarea>
              </div>

              <div class="field-block">
                <label class="field-label"><strong>Embarazo</strong></label>
                {% set embar = (val('embarazo') or '')|trim %}
                {% set allowed = ['Si','Sí','No','Desconoce'] %}
                <select class="input" name="embarazo" required>
                  <option value="" disabled {{ (embar=='' or (embar not in allowed)) and 'selected' or '' }}>Seleccionar…</option>
                  <option value="Si"        {{ (embar in ['Si','Sí']) and 'selected' or '' }}>Sí</option>
                  <option value="No"        {{ embar=='No' and 'selected' or '' }}>No</option>
                  <option value="Desconoce" {{ embar=='Desconoce' and 'selected' or '' }}>Desconoce</option>
                </select>
              </div>

              <div class="field-block">
                <label class="field-label"><strong>Medicación recibida</strong></label>
                <textarea class="input textarea-fixed" name="medicacion_recibida">{{ val('medicacion_recibida') }}</textarea>
              </div>
              </div>
            </article>
          </div>
        </section>

        <!-- ======================= Columna 2 ======================= -->
        <section class="col">
          <div class="col-inner">
            <article class="card card--fill card--scroll card--equal card--muted" aria-labelledby="c2a-h">


              <header id="c2a-h">Antecedentes del paciente</header>
              <div class="scroll" style="flex:1 1 auto; min-height:0;">

              <div class="field-block">
                <label class="field-label"><strong>Antecedentes personales</strong></label>
                <textarea class="input textarea-fixed" name="antecedentes_personales">{{ val('antecedentes_personales') }}</textarea>
              </div>

              <div class="field-block">
                <label class="field-label"><strong>Antecedentes familiares relevantes</strong></label>
                <textarea class="input textarea-fixed" name="antecedentes_familiares">{{ val('antecedentes_familiares') }}</textarea>
              </div>

              <div class="field-block">
                <label class="field-label"><strong>Cirugías previas</strong></label>
                <textarea class="input textarea-fixed" name="cirugias_previas">{{ val('cirugias_previas') }}</textarea>
              </div>

              </div>


            </article>

            <!-- Se estira para igualar alto con las otras columnas; scroll interno si se pasa -->
            <article class="card card--fill card--scroll card--equal card--muted" aria-labelledby="c2b-h">

              <header id="c2b-h">Medicación</header>
              <div class="scroll" style="flex:1 1 auto; min-height:0;">

              <div class="field-block">
                <label class="field-label"><strong>Medicación habitual</strong></label>
                <textarea class="input textarea-fixed" name="medicacion_habitual">{{ val('medicacion_habitual') }}</textarea>
              </div>

              <div class="field-block">
                <label class="field-label"><strong>Alergias</strong></label>
                <textarea class="input textarea-fixed" name="alergias">{{ val('alergias') }}</textarea>
              </div>

              <div class="field-block">
                <label class="field-label"><strong>Vacunas</strong></label>
                <textarea class="input textarea-fixed" name="vacunas">{{ val('vacunas') }}</textarea>
              </div>

              </div>

            </article>
          </div>
        </section>

        <!-- ======================= Columna 3 ======================= -->
        <section class="col">
          <div class="col-inner">
            <article class="card card--fill card--scroll card-examen" aria-labelledby="c3-h">
              <header id="c3-h">Examen físico / Anamnesis</header>
              <div class="field-block" style="flex:1 1 auto; min-height:0;">
                <label class="sr-only">Examen físico / Anamnesis</label>
                <textarea class="input textarea-fixed" name="examen_fisico"
                          style="height:100%; min-height:0; max-height:none;">{{ val('examen_fisico') }}</textarea>
              </div>
            </article>
          </div>
        </section>
      </div>
    </form>
  </div>
{% endblock %}

{% block scripts %}
<script>
  // Edad a partir de fecha_nacimiento (YYYY-MM-DD o ISO)
  (function(){
    const el = document.getElementById('age-text');
    const raw = el?.dataset.birth || '';
    if (!raw) return;
    const d = new Date(raw);
    if (isNaN(d)) return;
    const t = new Date();
    let age = t.getFullYear() - d.getFullYear();
    const m = t.getMonth() - d.getMonth();
    if (m < 0 || (m === 0 && t.getDate() < d.getDate())) age--;
    el.textContent = age;
  })();

  // Reflejar triage del input al chip del header
  (function(){
    const input = document.getElementById('triage-input');
    const chip  = document.getElementById('triage-chip');
    if (!input || !chip) return;
    const sync = () => { chip.textContent = input.value || '—'; };
    sync();
    input.addEventListener('input', sync);
  })();
</script>
{% endblock %}


