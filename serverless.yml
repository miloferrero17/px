service: px
useDotenv: true 
provider:
  name: aws
  runtime: python3.9
  #region: us-east-1
  region: sa-east-1

  stage: ${opt:stage, 'dev'}
  environment:
    ENV: ${opt:stage, 'dev'}
    PX_ENV: ${opt:stage, 'dev'}
    OPENAI_API_KEY: ${env:OPENAI_API_KEY}
    SUPABASE_URL: ${env:SUPABASE_URL}
    SUPABASE_API_KEY: ${env:SUPABASE_API_KEY}
    TWILIO_ACCOUNT_SID: ${env:TWILIO_ACCOUNT_SID}
    TWILIO_AUTH_TOKEN: ${env:TWILIO_AUTH_TOKEN}
    TWILIO_WHATSAPP_NUMBER: ${env:TWILIO_WHATSAPP_NUMBER}
    PINECONE_API_KEY: ${env:PINECONE_API_KEY}
    WHATSAPP_PROVIDER: ${env:WHATSAPP_PROVIDER}
    META_API_VERSION: ${env:META_API_VERSION}
    META_WABA_PHONE_ID: ${env:META_WABA_PHONE_ID}
    META_WABA_TOKEN: ${env:META_WABA_TOKEN}
    META_VERIFY_TOKEN: ${env:META_VERIFY_TOKEN}
    WHATSAPP_MEDICAL_DIGEST_TO: ${env:WHATSAPP_MEDICAL_DIGEST_TO}
    PRIVACY_NOTICE_VERSION: ${env:PRIVACY_NOTICE_VERSION}
    PX_MEDICAL_DIGEST_OFFER_ENABLED: ${env:PX_MEDICAL_DIGEST_OFFER_ENABLED}
  iamRoleStatements:
    - Effect: "Allow"
      Action:
        - "s3:PutObject"
      Resource:
        - "arn:aws:s3:::mi-bucket-milito/*"

functions:
  app:
    name: px-${opt:stage, 'dev'}
    handler: wsgi_handler.handler
    timeout: 29
    memorySize: 1024
    events:
      - http:
          path: /
          method: ANY
      - http:
          path: /{proxy+}
          method: ANY

plugins:
  - serverless-wsgi
  - serverless-python-requirements
  - serverless-dotenv-plugin

custom:
  wsgi:
    app: app.app
    packRequirements: false
  pythonRequirements:
    dockerizePip: true
    slim: true
    prune: true           # quita paquetes no referenciados en tu c√≥digo
    include:
      - reportlab
    noDeploy:
      - boto3
      - botocore
      - pip
      - setuptools
      - wheel          # AWS ya provee boto3 en el runtime

package:
  exclude:
    - tests/**
    - __pycache__/**
    - .venv/**
    - venv/**
    - .git/**
    - .DS_Store
    - node_modules/**
    - .mypy_cache/**